---
export interface Props {
  slug: string;
  className?: string;
}

const { slug, className = "" } = Astro.props;
---

<div class="like-button-wrapper" data-slug={slug}>
  <button class:list={["group like-button", className]}>
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
      viewBox="0 0 24 24"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path
        d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
      ></path>
    </svg>
    <span class="like-count"></span>
  </button>
</div>

<style>
  .like-button-wrapper {
    @apply inline-flex items-center;
  }
  .like-button {
    @apply flex items-center gap-2 p-2 text-skin-base bg-transparent cursor-pointer;
  }
  .like-button .icon-tabler {
    @apply w-5 h-5 stroke-skin-accent scale-100 transition-transform hover:scale-125;
  }
  .like-button.liked .icon-tabler {
    @apply fill-red-500 stroke-red-500;
  }
  .like-count {
    @apply font-medium;
  }
</style>

<script>
  const wrapper = document.querySelector(".like-button-wrapper");
  const slug = wrapper?.getAttribute("data-slug");
  const button = wrapper?.querySelector(".like-button");
  const countSpan = wrapper?.querySelector(".like-count");

  async function updateUi(res: Response) {
    const { count, likedByUser } = await res.json();
    if (countSpan) countSpan.textContent = count ? String(count) : "";
    console.log("count:", count, "likedByUser:", likedByUser);
    button?.classList.toggle("liked", likedByUser);
    console.log("Button classes:", button?.className);
  }
  async function fetchCount() {
    const res = await fetch(`/api/like?post=${slug}`, {
      credentials: "include",
    });
    await updateUi(res);
  }

  button?.addEventListener("click", async () => {
    const res = await fetch(`/api/like?post=${slug}`, {
      method: "POST",
      credentials: "include",
    });
    await updateUi(res);
  });

  fetchCount();
</script>
